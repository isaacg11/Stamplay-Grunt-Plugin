/*
 * grunt-stamplay
 * https://github.com/Stamplay/grunt-stamplay
 *
 * Copyright (c) 2016 Mirko Di Serafino
 * Licensed under the MIT license.
 */

'use strict';
var Stamplay = require('stamplay-cli');

function _deployCommand() {
  var options = this.options();
  var args = {
    _: ['deploy']
  };

  options.ignore = (this.data.ignore) ? this.data.ignore : [];
  options.headers = (this.data.headers) ? this.data.headers : [];

  if (this.data && this.data.message) {
    args.m = this.data.message;
  }

  Stamplay.setConfiguration(options);
  Stamplay.deploy(args);
}


module.exports = function stamplay(grunt) {
  grunt.registerMultiTask('stamplay', 'Deploy your project with a grunt module', function task() {
    var done = this.async();
    grunt.log.writeln('Currently running the ' + this.target + ' task');

    switch (this.target) {
      case 'deploy':
        _deployCommand.call(this);
        break;
      default:
        grunt.fail.fatal('Target must only be deploy');
        done();
    }

    process.on('exit', function terminate() {
      done();
    });
  });
};
